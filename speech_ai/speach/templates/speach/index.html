<!DOCTYPE html>
{% load static %}
<html lang="zh-CN">

<head>
    <!-- Basic -->
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <link rel="icon" href="{% static 'favicon/logo.svg' %}">
    <!-- Site Metas -->
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>


    <title>æ¼”è®²è¯„åˆ†</title>

    <script>
        let Tips = 'è¯·ç‚¹å‡»åœ¨çº¿å½•åˆ¶(æˆäºˆæƒé™)ã€æœ¬åœ°è§†é¢‘ã€æ–‡æœ¬è¯„æµ‹' + decodeURI("ğŸ˜"); //æ–‡æœ¬è¯„æµ‹
        {#console.log(Tips);#}
    </script>

    <link href="{% static 'css/fontCharacter.css' %}" rel="stylesheet"/>
    <link href="{% static 'css/style.css' %}" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/index.css' %}">

</head>

<body background="{% static 'images/blue-background-img.png' %}">
<div class="hero_area">
    <!-- header section strats -->
    <header class="header_section">
        <div class="container">
            <nav class="navbar navbar-expand-lg custom_nav-container ">
                <a class="navbar-brand" href="/index">

                <svg t="1685327063583" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                    p-id="2074" width="60px" height="60px">
                    <path d="M840.51491965 202.02394239l-19.48151603-19.48151604c-49.1751171-49.1751171-128.51516225-49.1751171-177.53317036-0.15710901l-52.00307912 52.00307911L788.51184055 431.24597383l52.0030791-52.0030791c49.01800811-48.8608991 49.01800811-128.35805326 0-177.21895234zM566.3597141 259.52583649C530.69597103 295.18957957 521.42654002 346.72133168 537.60876705 391.02606977l-0.157109 0.15710898-284.99572656 285.30994457c-5.49881501 5.49881501-5.49881501 14.61113702 0 20.26706105l27.49407505 27.49407505-64.57179914 64.57179914L233.91706944 807.36492059l64.41469013-64.41469014 27.49407506 27.49407508c2.82796201 2.82796201 6.28436002 4.08483399 10.05497602 4.08483399 4.08483399 0 7.54123201-1.25687199 10.36919402-4.08483399l142.34075427-142.34075431v213.66824043h65.98578015V561.96066209L631.40284023 485.29146996c44.46184709 16.33933604 96.15070819 6.91279601 131.81445127-28.75094707l0.78554499-0.785545L566.9881501 258.74029149l-0.628436 0.785545zM554.73364807 521.42654002l-65.98578011 65.98578012-152.70994831 152.70994831-53.4170601-53.57416911 268.34217254-268.34217253c4.39905201 6.59857803 9.58364903 12.88293803 15.39668201 18.85308005l19.48151604 19.48151603c5.81303301 5.81303301 12.09739302 10.84052103 18.53886204 15.23957304L554.73364807 521.42654002z" fill="#2c2c2c" p-id="2075"></path></svg>

                <span>
                  Speech scoring system
                </span>
                </a>
                <button class="navbar-toggler" type="button" data-toggle="collapse"
                        data-target="#navbarSupportedContent"
                        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="s-1"> </span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <div class="d-flex ml-auto flex-column flex-lg-row align-items-center">
                        <ul class="navbar-nav">

                            <li class="nav-item active">
                                <a class="nav-link" href="/index"> ä¸»é¡µ <span class="sr-only">(current)</span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/judge/judge_homepage/">èµ›äº‹å¹¿åœº<span class="sr-only">(current)</span></a>
                            </li>
                            {% if login_status %}

                                <li class="nav-item">
                                    <a class="nav-link" href="/login/score"> è¯„æµ‹ç»“æœ </a>
                                </li>

                                {% comment %}<li class="nav-item">
                                    <a class="nav-link" href="/login/face/upload"> äººè„¸å½•å…¥ </a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link last_link" href="/login/logout"> æ³¨é”€ </a>
                                </li>{% endcomment %}

                                <li class="nav-item">
                                    <a class="nav-link last_link" href="/judge/judge_homepage/contact/"> è”ç³»æˆ‘ä»¬ </a>
                                </li>

                                {% comment %}<li class="nav-item">
                                    <a class="nav-link" href="/login/user/info">{{ user_name }}</a>
                                </li>{% endcomment %}
                                {% comment %}<li class="nav-item">
                                    <li class="nav-item">
                                        <a class="nav-link" href="/login/user/info">{{ user_name }}</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/login/face/upload">äººè„¸å½•å…¥</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link last_link" href="/login/logout">æ³¨é”€</a>
                                    </li>
                                </li>{% endcomment %}

                                <li class="nav-item">
                                    <div class="dropdown">
                                        <a class="nav-link dropdown-toggle" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            {{ user_name }}
                                        </a>
                                        <ul class="dropdown-menu" aria-labelledby="userDropdown">
                                            <li>
                                                <a class="dropdown-item" href="/login/face/upload">äººè„¸å½•å…¥</a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item" href="/login/logout">æ³¨é”€</a>
                                            </li>
                                        </ul>
                                    </div>
                                </li>

                            {% else %}

                                <li class="nav-item">
                                    <a class="nav-link last_link" href="/login"> ç™»å½• </a>
                                </li>

                            {% endif %}

                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <section class=" slider_section ">
        <div class="container">
            <div class="row">
                <div class="col-md-6 ">
                    <div class="detail_box">
                        <h1>
                            Welcome to <br>
                            the Speech Scoring System
                        </h1>
                        <div class="main">
                            <!-- æ—¥å¿—è¾“å‡ºåŒºåŸŸ -->
                            <div class="mainBox">
                                <div class="reclog"></div>
                            </div>
                        </div>


                    </div>

                </div>

                <div class="content">


                    <div class="panel" class="img_container">


                        <button class="btn" id="connect">åœ¨çº¿å½•åˆ¶</button>

                        <button class="btn" id="video-file">æœ¬åœ°è§†é¢‘</button>

                        <button class="btn" id="text-file" onclick="window.location.href='/upload/'">æ–‡æœ¬è¯„æµ‹</button>

                        <button class="btn" id="disconnect" style="display:none">å…³é—­å½•åˆ¶</button>

                        <button class="btn" id="startAnalyse" style="display:none">å¼€å§‹è¯„æµ‹</button>

                        <button class="btn" id="export-btn" style="display:none">è§†é¢‘å¯¼å‡º</button>

                        <button class="btn" id="video-play" style="display:none">æ’­æ”¾å¹¶åˆ†æ</button>
                        <button class="btn" id="video-upload" style="display:none">ä¸Šä¼ å¹¶åˆ†æ</button>

                        <button class="btn" id="result" style="display:none">è¯„æµ‹ç»“æœ</button>
                        <button class="btn" id="flush" style="display:none">å†æ¬¡è¯„æµ‹</button>


                    </div>


                    {# é€‰æ‹©æ‘„åƒå¤´ #}
                    <div class="device-list" id="devices">
                        <ul class="ul"></ul>
                        <button class="btn" id="close">å…³ é—­</button>
                    </div>

                    <div id='video'>
                        <video id="vid" style="display:none"></video>
                        <img src="{% static 'image/camera.png' %}" id="img-temp" alt="æ‘„åƒå¤´å›¾ç‰‡"/>
                        <canvas id="canvas2" class="canvas2"></canvas>
                        <div></div>
                    </div>

                </div>

            </div>

        </div>

    </section>

</div>

<script type="text/javascript" src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/bootstrap.js' %}"></script>
<script type="text/javascript" src="{% static 'js/owl.carousel.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/tracking-min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/face-min.js' %}"></script>

<script>
    if ("{{ tip }}" !== '') {
        alert("{{ tip }}");
    }
    {#console.log("{{ user_name|safe }}");#}

    // reclog("æç¤ºä¿¡æ¯", 1/2/ä¸å†™)  1ä»£è¡¨çº¢è‰²ï¼Œ2ä»£è¡¨ç»¿è‰²ï¼Œä¸æ ‡æ˜¯é»‘è‰²
    const frame = 20;
    const video = document.querySelector('video');

    const deviceList = document.getElementById('devices');
    const canvas = document.createElement('canvas');

    const ctx = canvas.getContext('2d', {willReadFrequently: true});
    const vid = document.getElementById('vid');
    const canvas2 = document.getElementById('canvas2');
    const ctx2 = canvas2.getContext('2d', {willReadFrequently: true});
    const tracker = new tracking.ObjectTracker('face');

    const start = document.getElementById('connect');
    const stop = document.getElementById('disconnect');
    const exportBtn = document.getElementById('export-btn');  // å¯¼å‡ºè§†é¢‘æŒ‰é’®
    const videoFileBtn = document.getElementById('video-file');
    const textFileBtn = document.getElementById('text-file');

    const videoPlayBtn = document.getElementById('video-play');
    const videoUploadBtn = document.getElementById('video-upload');
    const FlushBtn = document.getElementById('flush');
    const startAnalyseBth = document.getElementById('startAnalyse');
    const resultBth = document.getElementById('result');

    const imgTemp = document.getElementById('img-temp');
    const input = document.createElement('input');

    canvas2.setAttribute('width', '400');
    canvas2.setAttribute('height', '300');

    {#æ–‡æœ¬è¯„æµ‹ æŒ‰é’®#}
    textFileBtn.addEventListener('click', () => {
        if ("{{ user_name }}" === "") {
            alert('æ‚¨è¿˜æ²¡æœ‰ç™»å½•ï¼Œç‚¹å‡»ç¡®å®šè·³è½¬åˆ°ç™»å½•é¡µé¢');
            jump('login', 0);
        } else {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.doc,.docx,.txt,.pdf';
            input.style.display = 'none';
            document.body.appendChild(input);
            input.click();

            start.style.display = 'none';
            videoFileBtn.style.display = 'none';
            {#textFileBtn.style.display = "none";#}

            let param = new FormData();
            param.append("txt", input.files[0]);
            param.append("csrfmiddlewaretoken", '{{ csrf_token }}');

            if ($.active > 0) {
                reclog("æ–‡æœ¬ä¸Šä¼ åˆ†æä¸­...", 2);
            }
            $.ajax({
                {# éœ€è¦ä¿®æ”¹åœ°å€åˆ° login #}
                url: 'login/txt/',
                async: false,
                type: "POST",
                data: param,
                processData: false,
                dataType: "json",
                cache: false,
                contentType: false,
                success: function (ret) {
                    if (ret['status'] === true) {
                        reclog("æ–‡æœ¬ä¸Šä¼ åˆ†ææˆåŠŸ", 2)
                    } else {
                        reclog("æ–‡å‡ºç°é”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•!", 1)
                    }
                },
                error: function (ret) {
                    console.log('å‡ºç°é”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•!', 1);
                    console.log(ret);
                },
            });
        }
    });

    {#æœ¬åœ°è§†é¢‘é€‰æ‹©#}
    videoFileBtn.addEventListener('click', () => {
        if ("{{ user_name }}" === "") {
            alert('æ‚¨è¿˜æ²¡æœ‰ç™»å½•ï¼Œç‚¹å‡»ç¡®å®šè·³è½¬åˆ°ç™»å½•é¡µé¢');
            jump('login', 0);
        } else {
            reclog("åªèƒ½ä¸Šä¼ mp4æ ¼å¼çš„è§†é¢‘", 2);
            input.type = 'file';
            input.accept = 'video/mp4';
            input.style.display = 'none';
            document.body.appendChild(input);

            input.click();
            start.style.display = 'none';
            {#videoFileBtn.style.display = 'none';#}
            textFileBtn.style.display = "none";

            videoPlayBtn.style.display = '';
            videoUploadBtn.style.display = '';
        }
    });

    {#æœ¬åœ°è§†é¢‘ä¸Šä¼ æŒ‰é’®#}
    videoUploadBtn.addEventListener('click', async () => {
        videoFileBtn.style.display = 'none';

        let time = new Date().toLocaleString();
        let flag = true;
        const file = input.files[0];

        let extension = file.name.slice(file.name.lastIndexOf('.') + 1);
        if (extension === 'mp4') {
            videoUploadFuc();

            // ä¸Šä¼ è§†é¢‘
            videoUpload(file, flag, time, String(extension));
        } else {
            reclog("åˆ·æ–°ç•Œé¢ï¼Œé‡æ–°ä¸Šä¼ mp4æ ¼å¼çš„è§†é¢‘", 1);
        }

    });

    function videoUploadFuc() {
        videoUploadBtn.style.display = 'none';
        videoPlayBtn.style.display = 'none';
    }

    {# è§†é¢‘ä¸Šä¼  #}

    function videoUpload(data, analyseFlag, time, ext) {
        if (analyseFlag) {
            reclog("è§†é¢‘è¯„æµ‹ä¸­,ç”¨æ—¶å¯èƒ½è¾ƒä¹…,è¯·ä¸è¦åˆ·æ–°é¡µé¢", 2);
        } else {
            reclog("è§†é¢‘è¯„æµ‹ä¸­,ç”¨æ—¶å¯èƒ½è¾ƒä¹…,è¯·ä¸è¦åˆ·æ–°é¡µé¢", 2);
        }
        {#console.log(ext);#}

        let param = new FormData();
        //let blob = new Blob(chunks);
        let time_temp = time;
        {#let flag_temp = analyseFlag;#}

        if (time_temp == null) {
            time_temp = new Date().toLocaleString();
        }

        param.append("csrfmiddlewaretoken", '{{ csrf_token }}');
        param.append("video", data);
        param.append("videoExt", ext)
        param.append("user_name", "{{ user_name }}");
        param.append("time", time_temp);
        param.append("analyseFlag", analyseFlag);

        $.ajax({
            url: '/login/video',
            async: true,
            type: "POST",
            data: param,
            processData: false,
            dataType: "json",
            cache: false,
            contentType: false,
            success: function (ret) {
                if (analyseFlag) {
                    reclog("è¯„æµ‹ç»“æŸ, å¯ä»¥ç‚¹å‡»è¯„æµ‹ç»“æœæŒ‰é’®æŸ¥çœ‹ç»“æœ", 2);
                    resultBth.style.display = "";
                    FlushBtn.style.display = '';
                    console.log(ret);
                } else {
                    reclog("è¯„æµ‹ç»“æŸ, å¯ä»¥ç‚¹å‡»è¯„æµ‹ç»“æœæŒ‰é’®æŸ¥çœ‹ç»“æœ", 2);
                    resultBth.style.display = "";
                    FlushBtn.style.display = '';
                }
                {#console.log(ret['tip']);#}

            },
            error: function (ret) {
                if (analyseFlag) {
                    reclog("å½•åˆ¶æ—¶é—´å¤ªçŸ­æˆ–å£°éŸ³å¤ªå°ï¼Œè¯·ç‚¹å‡»å†æ¬¡è¯„æµ‹é‡è¯•!", 1);
                } else {
                    reclog("å½•åˆ¶æ—¶é—´å¤ªçŸ­æˆ–å£°éŸ³å¤ªå°ï¼Œè¯·ç‚¹å‡»å†æ¬¡è¯„æµ‹é‡è¯•!", 1);
                }
                console.log(ret);
            },
        })
    }


    {#è¿”å›ä¸»é¡µ æŒ‰é’®#}
    FlushBtn.addEventListener('click', () => {
        location.reload();

    });

    {#æœ¬åœ°è§†é¢‘æ’­æ”¾åˆ†æ æŒ‰é’®#}
    videoPlayBtn.addEventListener('click', () => {
        videoFileBtn.style.display = 'none';

        let time = new Date().toLocaleString();
        let flag = true;
        const file = input.files[0];

        let extension = file.name.slice(file.name.lastIndexOf('.') + 1);

        if (extension === 'mp4') {
            {#ä¸Šä¼ è§†é¢‘#}
            videoUpload(file, flag, time, String(extension));
            {#æ’­æ”¾è§†é¢‘#}
            videoPlayFuc(file);
        } else {
            reclog("åˆ·æ–°ç•Œé¢ï¼Œé‡æ–°ä¸Šä¼ mp4æ ¼å¼çš„è§†é¢‘", 1);
        }
    });

    {#æœ¬åœ°è§†é¢‘æ’­æ”¾åˆ†æ å‡½æ•°#}

    async function videoPlayFuc(file) {
        vid.style.display = "";
        imgTemp.style.display = "none";
        videoUploadBtn.style.display = "none";
        videoPlayBtn.style.display = "none";

        video.src = URL.createObjectURL(file);
        await video.play();

        video.onloadedmetadata = function () {
            {% comment %} function getStyle(obj, attr) {
                if (obj.currentStyle) {
                    return obj.currentStyle[attr];
                } else {
                    return getComputedStyle(obj)[attr];
                }
            }{% endcomment %}

            let wid = getStyle(video, 'width').slice(0, -2);
            let hei = getStyle(video, 'height').slice(0, -2);

            canvas.setAttribute('width', wid);
            canvas.setAttribute('height', hei);
            canvas2.setAttribute('width', wid);
            canvas2.setAttribute('height', hei);
        };


        {# æˆåŠŸåå‡ºç°è¯„æµ‹ç»“æœ æŒ‰é’® #}
        video.addEventListener('pause', function () { //æš‚åœå¼€å§‹æ‰§è¡Œçš„å‡½æ•°
            vid.style.display = "none";
            resultBth.style.display = '';
            FlushBtn.style.display = "";
            tra.stop();

            ctx2.clearRect(0, 0, 400, 300);
            imgTemp.style.display = "";
        });

        tracker.setInitialScale(4); //åˆå§‹æ¯”ä¾‹
        tracker.setStepSize(2); // è®¾ç½®æ­¥é•¿
        tracker.setEdgesDensity(0.1); // è®¾ç½®è¾¹å¯†åº¦


        let tra = tracking.track('#vid', tracker);

        tracker.on('track', function (event) {
            ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
            event.data.forEach(function (rect) {
                ctx2.strokeStyle = '#00FF00'; // 00fe44
                ctx2.strokeRect(rect.x, rect.y, rect.width, rect.height);

            });
        });


    }

    {#å¼€å¯æ‘„åƒå¤´#}
    document.getElementById('connect').onclick = function () {
        navigator.mediaDevices.enumerateDevices().then(function (devices) {
                if ("{{ user_name }}" === "") {
                    alert('æ‚¨è¿˜æ²¡æœ‰ç™»å½•ï¼Œç‚¹å‡»ç¡®å®šè·³è½¬åˆ°ç™»å½•é¡µé¢');
                    jump('login', 0);
                }
                // console.log(devices);
                const videoInputs = devices.filter(d => d.kind === 'videoinput');
                if (!videoInputs.length) {
                    alert('è¯·æ¥å…¥æ‘„åƒå¤´');

                } else if (videoInputs.length === 1) {

                    connectCamera(videoInputs[0].groupId);

                } else {
                    const lis = videoInputs.map((d, i) => `<li id="${d.groupId}">æ‘„åƒå¤´${i + 1}</li>`);
                    deviceList.querySelector('ul').innerHTML = lis.join('');
                    deviceList.classList.add('active');
                }
            }
        )
    };


    {#é€‰æ‹©æ‘„åƒå¤´#}
    deviceList.onclick = function (e) {
        const t = e.target;
        if (t.nodeName === 'LI') {
            connectCamera(t.id);
            deviceList.classList.remove('active');
        }
    };

    {#å…³é—­æ‘„åƒå¤´é€‰æ‹©#}
    document.getElementById('close').onclick = function () {
        deviceList.classList.remove('active');
    };

    function sleep(millisecond) {
        return new Promise(resolve => {
            setTimeout(() => {
                resolve()
            }, millisecond)
        })
    }

    async function jump(key, seconds) {
        await sleep(seconds);
        window.location.href = '/' + key;
    }


    {#å¼€å§‹å½•åˆ¶#}

    function connectCamera(groupId) {
        imgTemp.style.display = "none";
        start.style.display = "none";
        videoFileBtn.style.display = "none";
        textFileBtn.style.display = "none";

        vid.style.display = "";
        stop.style.display = "";


        const videoWidth = 400;
        const videoHeight = 300;
        canvas.setAttribute('width', '400px');
        canvas.setAttribute('height', '300px');
        canvas2.setAttribute('width', '400px');
        canvas2.setAttribute('height', '300px');

        let time = new Date().toLocaleString();

        let sum = 0;
        let total = 0;

        let flag_start = true;
        let flag_end = false;

        setInterval(function () {
            sum = 0;
            console.log(1, flag_start, flag_end);
            if (flag_start === true) {
                flag_end = true;
            } else {
                flag_start = true;
            }
        }, 5000);

        let mediaRecorder;
        let chunks = [];

        navigator.mediaDevices.getUserMedia({
            video: {groupId, width: videoWidth, height: videoHeight},
            audio: {echoCancellation: true}
        }).then(function (stream) {
            video.srcObject = stream;
            video.volume = 0;
            {#mediaTrack = stream.getTracks()[0];#}
            {#audioTrack = stream.getTracks()[1];#}
            video.onloadedmetadata = function () { //e
                video.play();
            };

            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm'
            });

            mediaRecorder.ondataavailable = e => {
                if (e.data && e.data.size > 0) {
                    chunks.push(e.data);
                }
            };

            mediaRecorder.start();

            {#åœ¨çº¿å½•åˆ¶#}
            tracker.setInitialScale(4); //åˆå§‹æ¯”ä¾‹
            tracker.setStepSize(2); // è®¾ç½®æ­¥é•¿
            tracker.setEdgesDensity(0.1); // è®¾ç½®è¾¹å¯†åº¦

            let tra = tracking.track('#vid', tracker);


            let noFaceDetected = true;
            let timer;
            tracker.on('track', function (event) {
                ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
                if (event.data.length === 0) {
                    // no face detected
                    if (noFaceDetected) {
                        // start the timer
                        reclog('è¯·ä¿æŒé¢éƒ¨åœ¨æ‘„åƒå¤´ç”»é¢ä¸­', 2);
                        noFaceDetected = false;
                    }
                } else {
                    // face detected
                    clearTimeout(timer);
                    event.data.forEach(function (rect) {
                        ctx2.strokeStyle = '#00fe44'; // 00fe44
                        ctx2.strokeRect(rect.x, rect.y, rect.width, rect.height);

                        sum += 1;

                        if (flag_end || (sum % frame === 0 && flag_start)) {
                            console.log(2, flag_start, flag_end);
                            flag_start = false;
                            flag_end = false;
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            let imgURL = canvas.toDataURL('image/png', 1);
                            let img = new Image();
                            img.src = imgURL;

                            let currentTime = video.currentTime;

                            {#å›¾ç‰‡è½¬æˆBuffer#}

                            function dataURItoBlob(dataURI) {
                                let byteString = atob(dataURI.split(',')[1]);
                                let mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
                                let ab = new ArrayBuffer(byteString.length);
                                let ia = new Uint8Array(ab);
                                for (let i = 0; i < byteString.length; i++) {
                                    ia[i] = byteString.charCodeAt(i);
                                }
                                return new Blob([ab], {type: mimeString});
                            }

                            total += 1;
                            let param = new FormData();
                            let blob = dataURItoBlob(imgURL);
                            param.append("speech", blob);
                            param.append("csrfmiddlewaretoken", '{{ csrf_token }}');
                            param.append("time", time);
                            param.append("total", total);
                            param.append("imgTime", String(currentTime));

                            $.ajax({
                                url: '/login/speech',
                                async: false,
                                type: "POST",
                                data: param,
                                processData: false,
                                dataType: "json",
                                cache: false,
                                contentType: false,
                                success: function (ret) {
                                    if (ret['status'] === true) {
                                        console.log(ret['eps'])
                                    } else {
                                        console.log(ret)
                                    }
                                },
                                error: function (ret) {
                                    console.log('å¤±è´¥ ï¼ï¼ï¼');
                                    console.log(ret);
                                },
                            });
                        }
                    });
                }
            });

            document.getElementById('disconnect').onclick = function () {
                stop.style.display = "none";
                vid.style.display = "none";
                imgTemp.style.display = "";
                exportBtn.style.display = "";
                startAnalyseBth.style.display = "";
                {#FlushBtn.style.display = "";#}

                tra.stop();
                ctx2.clearRect(0, 0, videoWidth, videoHeight);

                mediaRecorder.onstop = () => {
                    {#let blob = new Blob(chunks, { type: 'video/webm' });#}
                    {#videoUpload(blob, false, time, 'webm');#}
                    stream.getTracks().forEach(track => {
                        track.stop();
                    });
                };
                setTimeout(() => {
                    mediaRecorder.stop();
                }, 1000);
                video.pause();
            }
        }).catch(console.log);


        {#å¯¼å‡ºè§†é¢‘æŒ‰é’®ç‚¹å‡»#}
        exportBtn.addEventListener('click', () => {
            setTimeout(() => {
                let time = new Date().toLocaleString();
                let blob = new Blob(chunks, {type: 'video/webm'});
                let url = window.URL.createObjectURL(blob);
                let link = document.createElement("a");
                link.href = url;

                // ".webm"  ".mp4"
                link.download = "{{ user_name }}" + "_" + time + ".webm";
                link.style.display = "none";
                link.click();
                link.remove();
            }, 1000);
        });

        {#å¼€å§‹è¯„æµ‹æŒ‰é’®#}
        startAnalyseBth.addEventListener('click', () => {
            {#reclog("å¼€å§‹è¯„æµ‹...", 2);#}
            startAnalyseBth.style.display = 'none';
            {#exportBtn.style.display = 'none';#}
            {#resultBth.style.display = '';#}
            let blob = new Blob(chunks, {type: 'video/webm'});
            videoUpload(blob, false, time, 'webm');
        });

    }


    {#ç»“æœæŒ‰é’®#}
    resultBth.addEventListener('click', () => {
        {#è·³è½¬åˆ°ç»“æœé¡µé¢#}
        jump('login/score', 0);
    });

    function reclog(s, color) {
        const now = new Date();
        const t = ("0" + now.getHours()).slice(-2)
            + ":" + ("0" + now.getMinutes()).slice(-2) //substr(-2)
            + ":" + ("0" + now.getSeconds()).slice(-2);
        const div = document.createElement("div");
        const elem = document.querySelector(".reclog");
        elem.insertBefore(div, elem.firstChild);

        div.innerHTML = '<div style="color:' + (!color ? "" : color === 1 ? "red" : color === 2 ? "#0b1" : color) + '">[' + t + ']' + s + '</div>';
    }

    window.onerror = function (message, url, lineNo, columnNo, error) {
        reclog('<span style="color:red">ã€Uncaught Errorã€‘' + message + '<pre>' + "at:" + lineNo + ":" + columnNo + " url:" + url + "\n" + (error && error.stack || "ä¸èƒ½è·å¾—é”™è¯¯å †æ ˆ") + '</pre></span>');
    };


    reclog(Tips);

</script>


</body>

</html>