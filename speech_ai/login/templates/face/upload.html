<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport"
			content="width=device-width, user-scalable=no, initial-scale=1.0,
			maximum-scale=1.0, minimum-scale=1.0">
		<title>{{ page }}</title>
		<link rel="icon" href="{% static 'favicon/logo.svg'%}">

        <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.css'%}" />
        <link href="{% static 'css/fontFace.css' %}" rel="stylesheet">
        <link href="{% static 'css/style.css' %}" rel="stylesheet" />
        <link href="{% static 'css/responsive.css' %}" rel="stylesheet" />


        <link rel="stylesheet" href="{% static 'css/camera.css' %}">

	</head>

	<body background="{% static 'images/blue-background-img.png' %}">

        <div class="hero_area">
            <!-- header section strats -->
            <header class="header_section">
              <div class="container">
                <nav class="navbar navbar-expand-lg custom_nav-container ">
                  <a class="navbar-brand" href="/index">
                        <svg t="1685327063583" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                            p-id="2074" width="60px" height="60px">
                            <path d="M840.51491965 202.02394239l-19.48151603-19.48151604c-49.1751171-49.1751171-128.51516225-49.1751171-177.53317036-0.15710901l-52.00307912 52.00307911L788.51184055 431.24597383l52.0030791-52.0030791c49.01800811-48.8608991 49.01800811-128.35805326 0-177.21895234zM566.3597141 259.52583649C530.69597103 295.18957957 521.42654002 346.72133168 537.60876705 391.02606977l-0.157109 0.15710898-284.99572656 285.30994457c-5.49881501 5.49881501-5.49881501 14.61113702 0 20.26706105l27.49407505 27.49407505-64.57179914 64.57179914L233.91706944 807.36492059l64.41469013-64.41469014 27.49407506 27.49407508c2.82796201 2.82796201 6.28436002 4.08483399 10.05497602 4.08483399 4.08483399 0 7.54123201-1.25687199 10.36919402-4.08483399l142.34075427-142.34075431v213.66824043h65.98578015V561.96066209L631.40284023 485.29146996c44.46184709 16.33933604 96.15070819 6.91279601 131.81445127-28.75094707l0.78554499-0.785545L566.9881501 258.74029149l-0.628436 0.785545zM554.73364807 521.42654002l-65.98578011 65.98578012-152.70994831 152.70994831-53.4170601-53.57416911 268.34217254-268.34217253c4.39905201 6.59857803 9.58364903 12.88293803 15.39668201 18.85308005l19.48151604 19.48151603c5.81303301 5.81303301 12.09739302 10.84052103 18.53886204 15.23957304L554.73364807 521.42654002z" fill="#2c2c2c" p-id="2075"></path></svg>

                        <span>
                          Speech scoring system
                        </span>
                  </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="s-1"> </span>
                  </button>
                  <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <div class="d-flex ml-auto flex-column flex-lg-row align-items-center">
                      <ul class="navbar-nav">

                      {% comment %}  <li class="nav-item">
                          <a class="nav-link" href="/index"> 主页 </a>
                        </li>

                          <li class="nav-item">
                              <a class="nav-link" href="/login/score"> 评测结果 </a>
                          </li>


                          <li class="nav-item active">
                              <a class="nav-link" href="/login/face/upload"> 人脸录入 </a>
                          </li>

                          <li class="nav-item">
                             <a class="nav-link last_link" href="testimonial.html"> 待定 </a>
                              <a class="nav-link last_link" href="/login/logout"> 注销 </a>
                          </li>

                          <li class="nav-item">
                              <a class="nav-link" href="/login/user/info">{{ user_name }}</a>
                          </li>{% endcomment %}

                          <li class="nav-item">
                                <a class="nav-link" href="/index"> 主页 <span class="sr-only">(current)</span></a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/judge/judge_homepage/">赛事广场<span class="sr-only">(current)</span></a>
                            </li>

                            {% if login_status %}

                                <li class="nav-item">
                                    <a class="nav-link" href="/login/score"> 评测结果 </a>
                                </li>

                                <li class="nav-item active">
                                    <a class="nav-link" href="/login/face/upload"> 人脸录入 </a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link last_link" href="/login/logout"> 注销 </a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link last_link" href="/judge/judge_homepage/contact/"> 联系我们 </a>
                                </li>

                                <li class="nav-item">
                                    <a class="nav-link" href="/login/user/info">{{ user_name }}</a>
                                </li>

                            {% else %}

                                <li class="nav-item">
                                    <a class="nav-link last_link" href="/login"> 登录 </a>
                                </li>

                            {% endif %}


                      </ul>
                    </div>
                  </div>
                </nav>
              </div>
            </header>
		
            <div class="content" >
                <h2 id="txt"> 请点击开启摄像头，并看向摄像头 </h2>

                <div class="panel">
                    <button class="btn" id="connect">开启摄像头</button>
                    <button class="btn" id="disconnect" style="display:none">关闭摄像头</button>
                    <!-- <button class="btn" id="capture">截图</button> -->
                </div>

                <div id='video'>
                    <img src="{% static 'image/camera.png' %}" id="img-temp" style="height: 450px; width: 600px" alt="摄像头图片"/>
                    <video id="vid" style="display:none"></video>
                    <canvas id="canvas2" class="canvas2" style="display:none"></canvas>
                </div>

                <div class="device-list" id="devices">
                    <ul class="ul"></ul>
                    <button class="btn" id="close">关 闭</button>
                </div>

                <div class="img-list" id="imgList">
                </div>
            </div>

        </div>

		<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
		<script src="{% static 'js/tracking-min.js' %}" type="text/javascript"></script>
{#        <script src="{% static 'js/tracking.js' %}" type="text/javascript"></script>#}
		<script src="{% static 'js/face-min.js' %}" type="text/javascript"></script>
{#		 <script src="{% static 'js/camera.js' %}"></script> #}

		<script>
			const msg_style = document.getElementById("txt");

			const start = document.getElementById('connect');
  			const stop = document.getElementById('disconnect');

			const videoWidth = 600;
			const videoHeight = 450;
			const video = document.querySelector('video');
			const deviceList = document.getElementById('devices');
			const canvas = document.createElement('canvas');

			let mediaTrack = null;
			const ctx = canvas.getContext('2d', {willReadFrequently: true});
			const imgList = document.getElementById('imgList');

			const vid = document.getElementById('vid');
			const canvas2 = document.getElementById('canvas2');

            canvas.setAttribute('width', '600px');
            canvas.setAttribute('height', '450px');
            canvas2.setAttribute('width', '640px');
            canvas2.setAttribute('height', '450px');

			const ctx2 = canvas2.getContext('2d');
			const tracker = new tracking.ObjectTracker('face');

            const imgTemp = document.getElementById('img-temp');

            let sum = 0;
            let count = 0;
            const param = new FormData();


            // 开启摄像头
			// document.getElementById('connect').onclick = connect()
			document.getElementById('connect').onclick = function ()  {
				navigator.mediaDevices.enumerateDevices().then(function (devices) {
						// console.log(devices);
						const videoInputs = devices.filter(d => d.kind === 'videoinput');
						if (!videoInputs.length) {
							alert('请接入摄像头');
						} else if(videoInputs.length === 1){
							connectCamera(videoInputs[0].groupId);

						} else {
							const lis = videoInputs.map((d, i) => `<li id="${d.groupId}">摄像头${i + 1}</li>`);
							deviceList.querySelector('ul').innerHTML = lis.join('');
							deviceList.classList.add('active');
						}
					}
				)
			};


			// 选择摄像头
			deviceList.onclick = function (e) {
				const t = e.target;
				if (t.nodeName === 'LI') {
					connectCamera(t.id);
					deviceList.classList.remove('active');
				}
			};

			// 关闭摄像头
			document.getElementById('close').onclick = function () {
				deviceList.classList.remove('active');
			};


			function jump(key){
				window.location.href = '/' + key;
			}

			function connectCamera(groupId) {
				start.style.display = "none";
                imgTemp.style.display = 'none';
                vid.style.display = "";
                canvas2.style.display = "";
				stop.style.display = "";

				navigator.mediaDevices
					.getUserMedia({
						video: { groupId, width: videoWidth, height: videoHeight },
                    }).then(function (stream) {
						video.srcObject = stream;
                        video.volume = 0;
                        {#mediaTrack = stream.getTracks()[0];#}
						video.onloadedmetadata = function () {
							video.play();
						};

						tracker.setInitialScale(4);
						tracker.setStepSize(2);
						tracker.setEdgesDensity(0.1);

                        // tracker.setInitialScale(2.8);
                        // tracker.setStepSize(1);
                        // tracker.setEdgesDensity(0.05);

                        tracking.track('#vid', tracker);

						tracker.on('track', function (event) {
							ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
							event.data.forEach(function (rect) {
								ctx2.strokeStyle = '#00fe44';
								ctx2.strokeRect(rect.x, rect.y, rect.width, rect.height);

                                msg_style.innerHTML = "正在录入，请保持面部在摄像头范围内";
                                sum += 1;
                                console.log(sum);

								if(sum % 5 === 0){
									ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
									let imgURL = canvas.toDataURL('image/png', 1); {# 0.9 #}
									let imgContainer = document.createElement('div');
									imgContainer.className = 'img';
									let img = new Image();
									img.src = imgURL;
									imgContainer.appendChild(img);
									imgList.appendChild(imgContainer);

									//图片转成Buffer
									function dataURItoBlob(dataURI) {
										let byteString = atob(dataURI.split(',')[1]);
										let mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
										let ab = new ArrayBuffer(byteString.length);
										let ia = new Uint8Array(ab);
										for (let i = 0; i < byteString.length; i++) {
											ia[i] = byteString.charCodeAt(i);
										}
										return new Blob([ab], {type: mimeString});
									}

									let blob = dataURItoBlob(imgURL);
									param.append('face', blob);
									count += 1;
									if (count === 3){
										param.append("csrfmiddlewaretoken",'{{ csrf_token }}');
										msg_style.innerHTML = "录入成功，正在上传...";
										$.ajax({
											url: '/login/face/upload',
											async: true,
											type: "POST",
											data: param,
											processData: false,
											dataType: "json",
											cache: false,
											contentType: false,
											success: function () {
												alert('录入成功，点击确定跳转到首页');
												jump('index');
											},
											error: function (ret) {
												alert('上传失败，点击确定刷新网页！');
												console.log(ret);
												location.reload();
											},
										})
									}
								}
								
							});
						});


						document.getElementById('disconnect').onclick = function () {
							// clearInterval(id);
                            canvas2.style.display = "none";
                            vid.style.display = "none";
                            stop.style.display = "none";
                            start.style.display = "";
                            imgTemp.style.display = '';

                            stream.getTracks().forEach(track => {
                                track.stop();
                            });

							sum = 0;
							count = 0;
							ctx2.clearRect(0, 0, videoWidth, videoHeight);

                            video.pause();
							video.srcObject = null;

						};
						
					}).catch(console.log);
			}
		</script>


	</body>

</html>