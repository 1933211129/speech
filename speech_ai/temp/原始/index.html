<!DOCTYPE html>
{% load static %}
<html lang="zh-CN">

<head>
  <!-- Basic -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- Mobile Metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link rel="icon" href="{% static 'favicon/face.png'%}">
  <!-- Site Metas -->
  <meta name="keywords" content="" />
  <meta name="description" content="" />
  <meta name="author" content="" />


<title>æ¼”è®²è¯„åˆ†</title>
<script>
var Tips='è¯·ç‚¹å‡»åœ¨çº¿å½•åˆ¶(æˆäºˆæƒé™)ã€æœ¬åœ°è§†é¢‘ã€æ–‡æœ¬è¯„æµ‹ï¼Œå¦‚æœè§†é¢‘äººè„¸è¾ƒå°ä½¿å¾—ç½‘é¡µæ— æ³•è¯†åˆ«è„¸éƒ¨ï¼Œè¯·ä½¿ç”¨ä¸Šä¼ åˆ†æ'+unescape("ğŸ˜");
console.log(Tips);
</script>


<!--
ã€1ã€‘å¼•å…¥æ¡†æ¶æ–‡ä»¶ï¼Œæ³¨æ„è‡ªå·±ä½¿ç”¨æ—¶åº”å½“è‡ªå·±æŠŠæºç cloneä¸‹æ¥ï¼Œç„¶åé€šè¿‡src="/src/recorder-core.js"å¼•å…¥ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿copyæ–‡ä»¶æµ‹è¯•èµ·è§ï¼Œä½¿ç”¨äº†JsDelivr CDNã€‚
å¦å¤–ï¼š[1.1]ã€[1.2]å¯ä»¥åˆå¹¶ä¸ºä½¿ç”¨"/recorder.mp3.min.js"ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸ºå‹ç¼©ç‰ˆå¤§å¹…å‡å°æ–‡ä»¶ä½“ç§¯ï¼Œå·²ç»åŒ…å«äº†è¿™3ä¸ªæºç æ–‡ä»¶
-->

<!-- ã€1.1ã€‘å¼•å…¥æ ¸å¿ƒæ–‡ä»¶ -->
<script src="https://cdn.jsdelivr.net/gh/xiangyuecn/Recorder@latest/src/recorder-core.js"></script>

<!-- ã€1.2ã€‘å¼•å…¥ç›¸åº”æ ¼å¼æ”¯æŒæ–‡ä»¶ï¼›å¦‚æœéœ€è¦å¤šä¸ªæ ¼å¼æ”¯æŒï¼ŒæŠŠè¿™äº›æ ¼å¼çš„ç¼–ç å¼•æ“jsæ–‡ä»¶æ”¾åˆ°åé¢ç»Ÿç»ŸåŠ è½½è¿›æ¥å³å¯ -->
<script src="https://cdn.jsdelivr.net/gh/xiangyuecn/Recorder@latest/src/engine/mp3.js"></script>
<script src="https://cdn.jsdelivr.net/gh/xiangyuecn/Recorder@latest/src/engine/mp3-engine.js"></script>

<!-- ã€1.3ã€‘å¼•å…¥å¯é€‰çš„æ‰©å±•æ”¯æŒé¡¹ï¼Œå¦‚æœä¸éœ€è¦è¿™äº›æ‰©å±•åŠŸèƒ½å¯ä»¥ä¸å¼•å…¥ -->
<script src="https://cdn.jsdelivr.net/gh/xiangyuecn/Recorder@latest/src/extensions/frequency.histogram.view.js"></script>
<script src="https://cdn.jsdelivr.net/gh/xiangyuecn/Recorder@latest/src/extensions/lib.fft.js"></script>

  <!-- slider stylesheet -->
  <link rel="stylesheet" type="text/css"
    href="{% static 'css/owl.carousel.min.css'%}" />

  <!-- bootstrap core css -->
  <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.css'%}" />

  <!-- fonts style -->
  <link href="https://fonts.googleapis.com/css?family=Lobster|Poppins:400,600,700&display=swap" rel="stylesheet">
  <!-- font awesome style -->
  <link href="{% static 'css/font-awesome.min.css' %}" rel="stylesheet" />
  <!-- Custom styles for this template -->
  <link href="{% static 'css/style.css' %}" rel="stylesheet" />
  <!-- responsive style -->
  <link href="{% static 'css/responsive.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/demo.css' %}">
  <!-- new-bg-style -->
  <link rel="stylesheet" href="{% static 'css/bg_css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/bg_css/animate.css' %}">
  <link rel="stylesheet" href="{% static 'css/bg_css/default.css' %}">
  <link rel="stylesheet" href="{% static 'css/bg_css/style.css' %}">

</head>

<body background="{% static 'images/blue-background-img.png' %}">
  <div class="hero_area">
    <!-- header section strats -->
    <header class="header_section">
      <div class="container">
        <nav class="navbar navbar-expand-lg custom_nav-container ">
          <a class="navbar-brand" href="/index">
            <svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
              x="0px" y="0px" viewBox="0 0 512.009 512.009" style="enable-background:new 0 0 512.009 512.009;"
              xml:space="preserve">
              <g>
                <g>
                  <path d="M370.634,395.38l4.715-0.917c5.547-1.067,136.661-26.773,136.661-95.808c0-21.461-6.933-36.8-20.651-45.611
			c-19.797-12.757-47.531-7.168-64.683-1.707v-16.683c0-17.643-14.357-32-32-32H96.009c-17.643,0-32,14.357-32,32v21.333
			c0,63.637,29.675,122.027,78.827,160H10.676c-4.309,0-8.213,2.603-9.856,6.592c-1.664,3.989-0.747,8.576,2.304,11.627
			l23.915,23.915c14.123,14.101,32.875,21.867,52.8,21.867h330.987c19.648,0,38.891-7.979,52.8-21.867l23.915-23.915
			c3.051-3.051,3.968-7.637,2.304-11.627c-1.664-3.989-5.547-6.592-9.856-6.592H347.807
			C356.02,409.673,363.593,402.783,370.634,395.38z M425.418,274.313c13.483-5.12,40.405-12.373,54.4-3.307
			c7.317,4.672,10.859,13.739,10.859,27.648c0,35.477-59.307,59.221-98.496,69.931C410.783,340.809,422.324,308.596,425.418,274.313
			z"></path>
                </g>
              </g>
              <g>
                <g>
                  <path d="M328.415,113.332c17.344-21.675,17.344-55.616,0-77.291c-3.733-4.608-10.432-5.312-14.997-1.664
			c-4.608,3.669-5.333,10.389-1.664,14.997c11.008,13.717,11.008,36.907-0.043,50.667c-17.365,21.653-17.365,55.616-0.021,77.291
			c2.133,2.645,5.205,4.011,8.341,4.011c2.347,0,4.715-0.768,6.677-2.347c4.608-3.669,5.333-10.389,1.664-14.997
			C317.364,150.281,317.364,127.092,328.415,113.332z"></path>
                </g>
              </g>
              <g>
                <g>
                  <path d="M264.308,113.332c17.365-21.675,17.365-55.616,0-77.291c-3.669-4.587-10.368-5.333-14.997-1.664
			c-4.608,3.669-5.333,10.389-1.664,14.997c10.987,13.717,10.987,36.907-0.021,50.667c-17.365,21.653-17.365,55.616,0,77.291
			c2.112,2.645,5.205,4.011,8.341,4.011c2.325,0,4.693-0.768,6.656-2.347c4.587-3.669,5.333-10.389,1.664-14.997
			C253.3,150.281,253.3,127.092,264.308,113.332z"></path>
                </g>
              </g>

            </svg>
            <span>
              Speech scoring system
            </span>
          </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="s-1"> </span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <div class="d-flex ml-auto flex-column flex-lg-row align-items-center">
              <ul class="navbar-nav  ">

                <li class="nav-item active">
                  <a class="nav-link" href="/index"> ä¸»é¡µ <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/judge/judge_homepage/">èµ›äº‹å¹¿åœº<span class="sr-only">(current)</span></a>
                </li>
                {% if login_status %}

                <li class="nav-item">
                  <a class="nav-link" href="/login/score/history_score"> å†å²è¯„æµ‹ </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/login/face/upload"> äººè„¸å½•å…¥ </a>
                </li>

                  <li class="nav-item">
                    <a class="nav-link last_link" href="/login/logout"> æ³¨é”€ </a>
                  </li>

                  <li class="nav-item">
                    <a class="nav-link last_link" href="/judge/judge_homepage/contact/"> è”ç³»æˆ‘ä»¬ </a>
                  </li>

                  <li class="nav-item">
                    <a class="nav-link" href="/login/user/info">{{ user_name }}</a>
                  </li>

                {% else %}

                  <li class="nav-item">
                    <a class="nav-link last_link" href="/login"> ç™»å½• </a>
                  </li>

                {% endif %}
                
              </ul>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <section class=" slider_section ">
      <div class="container">
        <div class="row">
          <div class="col-md-6 ">
            <div class="detail_box">
              <h1>
                Welcome to <br>
                the Speech Scoring System
              </h1>
               <div class="main">
                    <!-- æ—¥å¿—è¾“å‡ºåŒºåŸŸ -->
                    <div class="mainBox">
                        <div class="reclog"></div>
                    </div>
                </div>



            </div>

          </div>

          <div class="content">

    
            <div class="panel" class="img_container">


              <button class="btn" id="connect" >åœ¨çº¿å½•åˆ¶</button>

              <button class="btn" id="video-file" >æœ¬åœ°è§†é¢‘</button>

                <button class="btn" id="text-file" onclick="window.location.href='/upload/'">æ–‡æœ¬è¯„æµ‹</button>

              <button class="btn" id="disconnect" style="display:none">å…³é—­å½•åˆ¶</button>

                <button class="btn" id="startAnalyse" style="display:none">å¼€å§‹è¯„æµ‹</button>

              <button class="btn" id="export-btn" style="display:none">è§†é¢‘å¯¼å‡º</button>

              <button class="btn" id="video-play" style="display:none">æ’­æ”¾å¹¶åˆ†æ</button>
              <button class="btn" id="video-upload" style="display:none">ä¸Šä¼ å¹¶åˆ†æ</button>

              <button class="btn" id="result" style="display:none">è¯„æµ‹ç»“æœ</button>
              <button class="btn" id="flush" style="display:none">å†æ¬¡è¯„æµ‹</button>
              

            </div>
    

            {# é€‰æ‹©æ‘„åƒå¤´ #}
           <div class="device-list" id="devices">
              <ul class="ul"></ul>
              <button class="btn" id="close">å…³ é—­</button>
            </div>

            <div id='video'>
              <video id="vid" style="display:none"></video>
              <img src="/media/2.png" id="img-temp" alt="æ‘„åƒå¤´å›¾ç‰‡" />
              <canvas id="canvas2" class="canvas2"></canvas>
              <div></div>
            </div>

        </div>

        </div>

      </div>

    </section>

  </div>
  {% comment %} <main>
    <!-- ======slider-area-start=========================================== -->
    <div id="home" class="slider-area slider-area1 position-relative over-hidden">
        <div id="scene" class="position-absolute w-100 h-100 z-index11">
            <img data-depth="0.20" class="shape shape-1 d-none d-lg-block" src="{% static 'images/bg_img/shape1.png'%}" alt="#">
            <img data-depth="0.15" class="shape shape-2 sm-shape d-none d-lg-block" src="{% static 'images/bg_img/shape2.png'%}" alt="#">
            <img data-depth="0.30" class="shape shape-3 d-none d-lg-block" src="{% static 'images/bg_img/shape3.png'%}" alt="#">
            <img data-depth="0.10" class="shape shape-4 d-none d-lg-block" src="{% static 'images/bg_img/shape4.png'%}" alt="#">
            <img data-depth="0.20" class="shape shape-5 sm-shape d-none d-lg-block" src="{% static 'images/bg_img/shape5.png'%}" alt="#">
            <img data-depth="0.25" class="shape shape-6 d-none d-lg-block" src="{% static 'images/bg_img/shape6.png'%}" alt="">
            <img data-depth="0.10" class="shape shape-7 d-none d-lg-block" src="{% static 'images/bg_img/shape7.png'%}" alt="">
            <img data-depth="0.30" class="shape shape-8 d-none d-lg-block" src="{% static 'images/bg_img/shape8.png'%}" alt="">
            <img data-depth="0.15" class="shape shape-9 d-none d-lg-block" src="{% static 'images/bg_img/shape9.png'%}" alt="">
            <img data-depth="0.10" class="shape shape-10 sm-shape d-none d-lg-block" src="{% static 'images/bg_img/shape10.png'%}" alt="">
            <img data-depth="0.20" class="shape shape-11 d-none d-lg-block" src="{% static 'images/bg_img/shape11.png'%}" alt="">
            <img data-depth="0.15" class="shape shape-12 sm-shape d-none d-lg-block" src="{% static 'images/bg_img/shape10.png'%}" alt="">
            <img data-depth="0.25" class="shape shape-13 sm-shape d-none d-lg-block" src="{% static 'images/bg_img/shape5.png'%}" alt="">
            <img data-depth="0.10" class="shape shape-14 sm-shape d-none d-lg-block" src="{% static 'images/bg_img/shape5.png'%}" alt="">
        </div>
        <!-- /shape-slider -->
        <div class="container">
            <div class="single-slider slider-height1 d-flex align-items-center">
                <div class="slider-bg">
                    <img class="w-100 z-index-1" src="{% static 'images/bg_img/bg.png'%}" alt="">
                </div><!-- /slider-bg -->
            </div>
        </div>
    </div> {% endcomment %}
  <!-- /èƒŒæ™¯ -->

  <script type="text/javascript" src="{% static 'js/jquery-3.4.1.min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bootstrap.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/owl.carousel.min.js'%}"></script>
  <script src="{% static 'js/tracking-min.js'%}" type="text/javascript"></script>
  <script src="{% static 'js/face-min.js'%}" type="text/javascript"></script>
  <!--æ–°èƒŒæ™¯js-->
  {% comment %} <script type="text/javascript" src="{% static 'js/bg_js/modernizr-3.5.0.min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bg_js/jquery-1.12.4.min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bg_js/popper.min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bg_js/bootstrap.min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bg_js/parallax.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bg_js/one-page-nav-min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bg_js/slick.min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bg_js/wow.min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bg_js/plugins.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bg_js/jquery.meanmenu.min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bg_js/main.js'%}"></script> {% endcomment %}

<script>

    if("{{ tip }}" !== ''){
        alert("{{ tip }}");
    }


  // reclog("æç¤ºä¿¡æ¯", 1/2/ä¸å†™)  1ä»£è¡¨çº¢è‰²ï¼Œ2ä»£è¡¨ç»¿è‰²ï¼Œä¸æ ‡æ˜¯é»‘è‰²
  const frame = 30;
  const video = document.querySelector('video');
  
  const deviceList = document.getElementById('devices');
  const canvas = document.createElement('canvas');

  const ctx = canvas.getContext('2d', {willReadFrequently: true});
  const vid = document.getElementById('vid');
  const canvas2 = document.getElementById('canvas2');
  const ctx2 = canvas2.getContext('2d', {willReadFrequently:true});
  const tracker = new tracking.ObjectTracker('face');

  const start = document.getElementById('connect');
  const stop = document.getElementById('disconnect');
  const exportBtn = document.getElementById('export-btn');  // å¯¼å‡ºè§†é¢‘æŒ‰é’®
  const videoFileBtn = document.getElementById('video-file');
  const textFileBtn = document.getElementById('text-file');

  const videoPlayBtn = document.getElementById('video-play');
  const videoUploadBtn = document.getElementById('video-upload');
  const FlushBtn = document.getElementById('flush');
  const startAnalyseBth = document.getElementById('startAnalyse');
  const resultBth = document.getElementById('result');

  const imgTemp = document.getElementById('img-temp');
  const input = document.createElement('input');

  canvas2.setAttribute('width', 400);
  canvas2.setAttribute('height', 300);

  {#å¼€å§‹è¯„æµ‹æŒ‰é’®#}
  startAnalyseBth.addEventListener('click', () => {
      if ( "{{ user_name }}" === ""){
          alert('æ‚¨è¿˜æ²¡æœ‰ç™»å½•ï¼Œç‚¹å‡»ç¡®å®šè·³è½¬åˆ°ç™»å½•é¡µé¢');
          jump('login', 0);

      }

      else {
          reclog("å¼€å§‹è¯„æµ‹...", 2);
          aispeach();
          startAnalyseBth.style.display = 'none';
          exportBtn.style.display = 'none';
          resultBth.style.display = '';
      }
  });

  {#ç»“æœæŒ‰é’®#}
  resultBth.addEventListener('click', () => {
    {#è·³è½¬åˆ°ç»“æœé¡µé¢#}
    jump('login/score/last_score', 0);
  });

  {#æ–‡æœ¬è¯„æµ‹ æŒ‰é’®#}
  textFileBtn.addEventListener('click', () => {
      {% comment %}
    if ( "{{ user_name }}" == ""){
      alert('æ‚¨è¿˜æ²¡æœ‰ç™»å½•ï¼Œç‚¹å‡»ç¡®å®šè·³è½¬åˆ°ç™»å½•é¡µé¢');
      jump('login', 0);
    }
    else{

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.doc,.docx,.txt,.pdf';
      input.style.display = 'none';
      document.body.appendChild(input);
      input.click();

      start.style.display = 'none';
      videoFileBtn.style.display = 'none';
      textFileBtn.style.display = "none";

      let param = new FormData();
      param.append("txt", input.files[0]);
      param.append("csrfmiddlewaretoken",'{{ csrf_token }}');

      reclog("æ–‡æœ¬ä¸Šä¼ åˆ†æä¸­...", 2)

      $.ajax({

        {# éœ€è¦ä¿®æ”¹åœ°å€ #}

        url: 'upload/',
        async: true,
        type: "POST",
        data: param,
        processData: false,
        dataType: "json",
        cache: false,
        contentType: false,
        success: function (ret) {
            if (ret['status'] == true){
                reclog("æ–‡æœ¬ä¸Šä¼ åˆ†ææˆåŠŸ", 2)
            }
            else{
              reclog("æ–‡æœ¬ä¸Šä¼ æˆåŠŸï¼Œåˆ†æå¤±è´¥", 1)
            }
        },
        error: function (ret) {
            console.log('txtæ–‡ä»¶ä¸Šä¼ å¤±è´¥', 1);
            console.log(ret);
        },
      });
    }
    {% endcomment %}
  });



  {#æœ¬åœ°è§†é¢‘é€‰æ‹©#}
  videoFileBtn.addEventListener('click', () => {
    if ( "{{ user_name }}" === ""){
      alert('æ‚¨è¿˜æ²¡æœ‰ç™»å½•ï¼Œç‚¹å‡»ç¡®å®šè·³è½¬åˆ°ç™»å½•é¡µé¢');
      jump('login', 0);
    }
    else{

      input.type = 'file';
      input.accept = 'video/*';
      input.style.display = 'none';
      document.body.appendChild(input);

      input.click();
      start.style.display = 'none';
      videoFileBtn.style.display = 'none';
      textFileBtn.style.display = "none";

      videoPlayBtn.style.display = '';
      videoUploadBtn.style.display = '';


    }
  });

  {#æœ¬åœ°è§†é¢‘ä¸Šä¼ æŒ‰é’®#}
  videoUploadBtn.addEventListener('click', async () => {

      let time = new Date().toLocaleString();
      let flag = true;
      const file = input.files[0];

      videoUploadFuc();

      // ä¸Šä¼ è§†é¢‘
      videoUpload(file, flag, time);


  });

  function videoUploadFuc(){
    videoUploadBtn.style.display = 'none';
    videoPlayBtn.style.display = 'none';

  }

  {# è§†é¢‘ä¸Šä¼  #}
    {# FlushBtn.style.display = ""; #}
    {# resultBth.style.display = ''; #}
  function videoUpload(data, analyseFlag, time) {
      if (analyseFlag){
          reclog("è§†é¢‘ä¸Šä¼ åˆ†æä¸­, è¯·ä¸è¦åˆ‡æ¢é¡µé¢", 2);
      }
      else{
          reclog("è§†é¢‘ä¸Šä¼ ä¸­..., è¯·ä¸è¦åˆ‡æ¢é¡µé¢", 2);
      }

    let param = new FormData();
    //let blob = new Blob(chunks);
    let time_temp = time;
    let flag_temp = analyseFlag;

    if (time_temp == null){
      time_temp = new Date().toLocaleString();
    }

    param.append("csrfmiddlewaretoken",'{{ csrf_token }}');
    param.append("video", data);
    param.append("user_name", "{{ user_name }}");
    param.append("time", time_temp);
    param.append("analyseFlag", flag_temp);

    $.ajax({
      url: '/login/video',
      async: true,
      type: "POST",
      data: param,
      processData: false,
      dataType: "json",
      cache: false,
      contentType: false,
      success: function (ret) {
          if (flag_temp){
              reclog("è§†é¢‘åˆ†æç»“æŸ, ç‚¹å‡»è¯„æµ‹ç»“æœæŒ‰é’®æŸ¥çœ‹æœ¬æ¬¡è¯„æµ‹ç»“æœ", 2);
              resultBth.style.display = "";
              FlushBtn.style.display = '';
          }
          else{
              reclog("è§†é¢‘ä¸Šä¼ æˆåŠŸ", 2);
          }
        {#console.log(ret['tip']);#}

      },
      error: function (ret) {
          if (flag_temp){
              reclog("è§†é¢‘åˆ†æå¤±è´¥", 1);
          }
          else{
              reclog("è§†é¢‘ä¸Šä¼ å¤±è´¥", 1);
          }
          console.log(ret);
      },
    })
  }


  {#è¿”å›ä¸»é¡µ æŒ‰é’®#}
  FlushBtn.addEventListener('click', () => {
    location.reload();

  });

  {#æœ¬åœ°è§†é¢‘æ’­æ”¾åˆ†æ æŒ‰é’®#}
  videoPlayBtn.addEventListener('click', () => {

    let time = new Date().toLocaleString();
    let flag = false;
    const file = input.files[0];

    {#ä¸Šä¼ è§†é¢‘#}
    {# å–æ¶ˆæ³¨é‡Š #}
    {#videoUpload(file, flag, time);#}

    {#æ’­æ”¾è§†é¢‘#}
    videoPlayFuc(file, time);


  });

  {#æœ¬åœ°è§†é¢‘æ’­æ”¾åˆ†æ å‡½æ•°#}
  {#åˆ†æç»“æŸåï¼Œå†å‡ºç°é‡æ–°å¼€å§‹æŒ‰é’® å’Œ è¯„æµ‹ç»“æœæŒ‰é’®#}
    {# FlushBtn.style.display = ""; #}
    {# resultBth.style.display = ''; #}
  async function videoPlayFuc(file, time){
    vid.style.display = "";
    imgTemp.style.display = "none";
    videoUploadBtn.style.display = "none";
    videoPlayBtn.style.display = "none";

    video.src = URL.createObjectURL(file);
    await video.play();

    video.onloadedmetadata = function() {
      function getStyle(obj, attr) {
          if (obj.currentStyle) {
              return obj.currentStyle[attr];
          } else {
              return getComputedStyle(obj)[attr];
          }
      }

      let wid = getStyle(video,'width').slice(0, -2);
      let hei = getStyle(video,'height').slice(0, -2);

      canvas.setAttribute('width', wid);
      canvas.setAttribute('height', hei);
      canvas2.setAttribute('width', wid);
      canvas2.setAttribute('height', hei);
    };


    {# æˆåŠŸåå‡ºç°è¯„æµ‹ç»“æœ æŒ‰é’® #}
    video.addEventListener('pause', function () { //æš‚åœå¼€å§‹æ‰§è¡Œçš„å‡½æ•°
        vid.style.display = "none";
        resultBth.style.display = '';
        FlushBtn.style.display = "";

        tra.stop();

        ctx2.clearRect(0, 0, 400, 300);

        imgTemp.style.display = "";

    });

    let sum = 0;
    let total = 0;

    tracker.setInitialScale(4);
    tracker.setStepSize(2);
    tracker.setEdgesDensity(0.1);

    {#tracker.setInitialScale(2.8);#}
    {#tracker.setStepSize(1);#}
    {#tracker.setEdgesDensity(0.05);#}

    let tra = tracking.track('#vid', tracker);

    tracker.on('track', function (event) {
        ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
        event.data.forEach(function (rect) {
          ctx2.strokeStyle = '#00FF00'; // 00fe44
          ctx2.strokeRect(rect.x, rect.y, rect.width, rect.height);

          sum += 1;

          if(sum % frame === 0){
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            {#è·å–è¯¥å¼ å›¾ç‰‡åœ¨è§†é¢‘ä¸­çš„æ—¶é—´#}
            let currentTime = video.currentTime;
            //console.log(currentTime);

            let imgURL = canvas.toDataURL('image/png', 1);
            let img = new Image();
            img.src = imgURL;

            {#å›¾ç‰‡è½¬æˆBuffer#}
            function dataURItoBlob(dataURI) {
                let byteString = atob(dataURI.split(',')[1]);
                let mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
                let ab = new ArrayBuffer(byteString.length);
                let ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                return new Blob([ab], {type: mimeString});
            }

            total += 1;
            let param = new FormData();
            let blob = dataURItoBlob(imgURL);
            param.append("speech", blob);
            param.append("csrfmiddlewaretoken",'{{ csrf_token }}');
            param.append("time", time);
            param.append("total", total);
            param.append("imgTime", currentTime.toString());

            $.ajax({
              url: '/login/speech',
              async: false,
              type: "POST",
              data: param,
              processData: false,
              dataType: "json",
              cache: false,
              contentType: false,
              success: function (ret) {
                  if (ret['status'] === true){
                      console.log(ret['eps']);
                    }
                  else{
                      console.log(ret);
                  }
              },
              error: function (ret) {
                  console.log('å¤±è´¥ ï¼ï¼ï¼');
                  console.log(ret);
              },

            });

          }

        });

    });
  }

  {#å¼€å¯æ‘„åƒå¤´#}
  document.getElementById('connect').onclick = function ()  {
      navigator.mediaDevices.enumerateDevices().then(function (devices) {
          if ( "{{ user_name }}" === ""){
            alert('æ‚¨è¿˜æ²¡æœ‰ç™»å½•ï¼Œç‚¹å‡»ç¡®å®šè·³è½¬åˆ°ç™»å½•é¡µé¢');
            jump('login', 0);
          }
          // console.log(devices);
          const videoInputs = devices.filter(d => d.kind === 'videoinput');
          if (!videoInputs.length) {
              alert('è¯·æ¥å…¥æ‘„åƒå¤´');

          } else if(videoInputs.length === 1){

              connectCamera(videoInputs[0].groupId);

          } else {
              const lis = videoInputs.map((d, i) => `<li id="${d.groupId}">æ‘„åƒå¤´${i + 1}</li>`);
              deviceList.querySelector('ul').innerHTML = lis.join('');
              deviceList.classList.add('active');
          }
        }
      )
  };


  {#é€‰æ‹©æ‘„åƒå¤´#}
  deviceList.onclick = function (e) {
      const t = e.target;
      if (t.nodeName === 'LI') {
          connectCamera(t.id);
          deviceList.classList.remove('active');
      }
  };

  {#å…³é—­æ‘„åƒå¤´é€‰æ‹©#}
  document.getElementById('close').onclick = function () {
      deviceList.classList.remove('active');
  };

  function sleep(millisecond) {
      return new Promise(resolve => {
          setTimeout(() => {
              resolve()
          }, millisecond)
      })
  }

  async function jump(key, seconds){
      await sleep(seconds);
      window.location.href = '/' + key;
  }

  {#å¼€å§‹å½•åˆ¶#}
  function connectCamera(groupId) {
    imgTemp.style.display = "none";
    start.style.display = "none";
    videoFileBtn.style.display = "none";
    textFileBtn.style.display = "none";

    vid.style.display = "";
    stop.style.display = "";


    const videoWidth = 400;
    const videoHeight = 300;
    canvas.setAttribute('width', '400px');
    canvas.setAttribute('height', '300px');
    canvas2.setAttribute('width', '400px');
    canvas2.setAttribute('height', '300px');

    let time = new Date().toLocaleString();

    let sum = 0;
    let total = 0;

    let flag_temp = false;
    setTimeout(function(){
      sum = 0;
      flag_temp = true;
    }, 3000);

    let chunks = [];  // å­˜æ”¾è§†é¢‘æ•°æ®
    let mediaTrack;
    let audioTrack;

    let mediaRecorder;

    navigator.mediaDevices
      .getUserMedia({
          video: { groupId, width: videoWidth, height: videoHeight },
          audio: { echoCancellation: true }
      })
      .then(function (stream) {
        video.srcObject = stream;
        video.volume = 0;
        mediaTrack = stream.getTracks()[0];
        audioTrack = stream.getTracks()[1];
        video.onloadedmetadata = function (e) {
            video.play();
        };

        {# éŸ³é¢‘åˆ†æå¼€å§‹ #}
        recStart();

        {#åˆ›å»ºåª’ä½“å½•åˆ¶#}
        mediaRecorder = new MediaRecorder(stream, {
          mimeType: 'video/webm'
        });

        {#console.log('å¼€å§‹é‡‡é›†');#}
        mediaRecorder.start();

        tracker.setInitialScale(3);
        tracker.setStepSize(2);
        tracker.setEdgesDensity(0.1);
        let tra = tracking.track('#vid', tracker);

        tracker.on('track', function (event) {
            ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
            event.data.forEach(function (rect) {
              ctx2.strokeStyle = '#00fe44';
              ctx2.strokeRect(rect.x, rect.y, rect.width, rect.height);

              sum += 1;

              if(sum % frame === 0 || flag_temp){
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                let imgURL = canvas.toDataURL('image/png', 1);
                let img = new Image();
                img.src = imgURL;

                let currentTime = video.currentTime;

                {#å›¾ç‰‡è½¬æˆBuffer#}
                function dataURItoBlob(dataURI) {
                    let byteString = atob(dataURI.split(',')[1]);
                    let mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
                    let ab = new ArrayBuffer(byteString.length);
                    let ia = new Uint8Array(ab);
                    for (let i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    return new Blob([ab], {type: mimeString});
                }

                total += 1;
                let param = new FormData();
                let blob = dataURItoBlob(imgURL);
                param.append("speech", blob);
                param.append("csrfmiddlewaretoken",'{{ csrf_token }}');
                param.append("time", time);
                param.append("total", total);
                param.append("imgTime", currentTime);

                $.ajax({
                  url: '/login/speech',
                  async: false,
                  type: "POST",
                  data: param,
                  processData: false,
                  dataType: "json",
                  cache: false,
                  contentType: false,
                  success: function (ret) {
                      if (ret['status'] === true){
                          console.log(ret['eps'])
                        }
                      else{
                          console.log(ret)
                      }
                  },
                  error: function (ret) {
                      console.log('å¤±è´¥ ï¼ï¼ï¼');
                      console.log(ret);
                  },
                });

                flag_temp = false;
                setTimeout(function(){
                  sum = 0;
                  flag_temp = true;
                }, 2000);

              }

            });
        });

        document.getElementById('disconnect').onclick = function (){

          stop.style.display = "none";
          vid.style.display = "none";

          imgTemp.style.display = "";
          exportBtn.style.display = "";
          startAnalyseBth.style.display = "";
          FlushBtn.style.display = "";

          tra.stop();

          ctx2.clearRect(0, 0, videoWidth, videoHeight);

          mediaRecorder.stop();

          {# éŸ³é¢‘åˆ†æç»“æŸ #}
          recStop();

          {#æ”¶é›†å½•åˆ¶æ•°æ®#}
          mediaRecorder.ondataavailable = e => {
            if (e.data && e.data.size > 0) {
              chunks.push(e.data);

              {#ä¸Šä¼ è§†é¢‘#}
              videoUpload(e.data, false, time);
            }
          };

          if (mediaTrack) {
            mediaTrack.stop();
          }
          if (audioTrack) {
            audioTrack.stop();
          }
          video.pause();

          //mediaRecorder = null;
          //mediaTrack = null;
          //audioTrack = null;
          //video.srcObject = null;

          {#console.log('åœæ­¢é‡‡é›†');#}
        }
      }).catch(console.log);

      {#å¯¼å‡ºè§†é¢‘æŒ‰é’®ç‚¹å‡»#}
      exportBtn.addEventListener('click', () => {

        let time = new Date().toLocaleString();
        console.log(time);

        let blob = new Blob(chunks);

        let url = window.URL.createObjectURL(blob);
        let link = document.createElement("a");
        link.href = url;

        // ".webm"  ".mp4"
        link.download = "{{ user_name }}" + "_" + time + ".webm";

        link.style.display = "none";

        link.click();
        link.remove();

      });

  }


  let rec, wave, recBlob;

  function recStart(){
      {#æ‰“å¼€äº†å½•éŸ³åæ‰èƒ½è¿›è¡Œstartã€stopè°ƒç”¨#}
    console.log("å·²å¼€å§‹å½•éŸ³...")
        $.ajax({
            type:"GET",
            contentType:"application/json;charset=UTF-8",
            url:"/start_record",
            success:function(result){
                console.log("success!")
            },
            error:function(e){
                console.log(e.status);
                // console.log(e.responseText);
            }
        })
        reclog("å·²å¼€å§‹å½•éŸ³...");

    };

    function recStop(){
    console.log("å½•éŸ³ç»“æŸ...")
    $.ajax({
            type:"GET",
            contentType:"application/json;charset=UTF-8",
            url:"/stop_record",
            success:function(result){
                console.log("success!")
                console.log(result)
            },
            error:function(e){
                console.log(e.status);
                // console.log(e.responseText);
            }
        })
        recBlob="1"
        reclog("å½•éŸ³ç»“æŸ...");
  };


    $(".btn-savename").click(function(){
        $.ajax({
            type:"GET",
            contentType:"application/json;charset=UTF-8",
            url:"/set_name",
            success:function(result){
                console.log("success!")
                console.log(result)
                alert("è®¾ç½®æˆåŠŸï¼")
            },
            error:function(e){
            console.log(e.status);
            console.log(e.responseText);
            }
        })
    })

  function aispeach() {
      if (!recBlob) {
          reclog("è¯·å…ˆå½•åˆ¶ï¼Œç„¶ååœæ­¢åå†è¯„æµ‹", 1);
          return;
      };
      $.ajax({
          type: "GET",
          contentType: "application/json;charset=UTF-8",
          url: "/evaluation",
          success: function (result) {
              console.log("success!")
              console.log(result)
              reclog("è¯„æµ‹å®Œæˆ...", 2);
              resultBth.style.display = ''
              FlushBtn.style.display = ''

          },
          error: function (e) {
              console.log(e.status);
              console.log(e.responseText);
              reclog("è¯„æµ‹å¤±è´¥...", 1);
          }
      })
      reclog("æ­£åœ¨è¿›è¡Œè¯„æµ‹...", 2);
  }




  function getmusic(){
      if(!recBlob){
      reclog("è¯·å…ˆå½•éŸ³ï¼Œç„¶åå†è¿›è¡Œè¯„æµ‹",1);
      return;
    }
      $.ajax({
          type:"GET",
          contentType:"application/json;charset=UTF-8",
          url:"/get_music",
          success:function(result){
              console.log("success!")
              console.log(result)
          },
          error:function(e){
          console.log(e.status);
          console.log(e.responseText);
          }
      })
      reclog("æˆåŠŸç”ŸæˆéŸ³ä¹...");
  }



  const dialogCancel=function(){
    clearTimeout(dialogInt);

    //å…³é—­å¼¹æ¡†ï¼Œåº”è¯¥ä½¿ç”¨è‡ªå·±çš„å¼¹æ¡†æ–¹å¼
      const elems = document.querySelectorAll(".waitDialog");
      for(let i=0; i<elems.length; i++){
      elems[i].parentNode.removeChild(elems[i]);
    }
  };
  //recOpenæˆ‘ä»¬å¯ä»¥é€‰æ‹©æ€§çš„å¼¹ä¸€ä¸ªå¯¹è¯æ¡†ï¼šä¸ºäº†é˜²æ­¢ç§»åŠ¨ç«¯æµè§ˆå™¨å­˜åœ¨ç¬¬ä¸‰ç§æƒ…å†µï¼šç”¨æˆ·å¿½ç•¥ï¼Œå¹¶ä¸”ï¼ˆæˆ–è€…å›½äº§ç³»ç»ŸUCç³»ï¼‰æµè§ˆå™¨æ²¡æœ‰ä»»ä½•å›è°ƒ
 const showDialog = function () {
      if (!/mobile/i.test(navigator.userAgent)) {
          return;//åªåœ¨ç§»åŠ¨ç«¯å¼€å¯æ²¡æœ‰æƒé™è¯·æ±‚çš„æ£€æµ‹
      }
      dialogCancel();

      //æ˜¾ç¤ºå¼¹æ¡†ï¼Œåº”è¯¥ä½¿ç”¨è‡ªå·±çš„å¼¹æ¡†æ–¹å¼
      const div = document.createElement("div");
      document.body.appendChild(div);
      div.innerHTML = (''
          + '<div class="waitDialog" style="z-index:99999;width:100%;height:100%;top:0;left:0;position:fixed;background:rgba(0,0,0,0.3);">'
          + '<div style="display:flex;height:100%;align-items:center;">'
          + '<div style="flex:1;"></div>'
          + '<div style="width:240px;background:#fff;padding:15px 20px;border-radius: 10px;">'
          + '<div style="padding-bottom:10px;">å½•éŸ³åŠŸèƒ½éœ€è¦éº¦å…‹é£æƒé™ï¼Œè¯·å…è®¸ï¼›å¦‚æœæœªçœ‹åˆ°ä»»ä½•è¯·æ±‚ï¼Œè¯·ç‚¹å‡»å¿½ç•¥~</div>'
          + '<div style="text-align:center;"><a onclick="waitDialogClick()" style="color:#0B1">å¿½ç•¥</a></div>'
          + '</div>'
          + '<div style="flex:1;"></div>'
          + '</div>'
          + '</div>');
  }; 

  let dialogInt;
  const createDelayDialog = function () {
      dialogInt = setTimeout(function () {//å®šæ—¶8ç§’åæ‰“å¼€å¼¹çª—ï¼Œç”¨äºç›‘æµ‹æµè§ˆå™¨æ²¡æœ‰å‘èµ·æƒé™è¯·æ±‚çš„æƒ…å†µï¼Œåœ¨openå‰æ”¾ç½®å®šæ—¶å™¨åˆ©äºæ”¶åˆ°äº†å›è°ƒèƒ½åŠæ—¶å–æ¶ˆï¼ˆä¸ç®¡openæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥å›è°ƒçš„ï¼‰
          showDialog();
      }, 8000);
  };
    //recOpenå¼¹æ¡†End

</script>





<!--ä»¥ä¸‹è¿™å¨å¯ä»¥å¿½ç•¥-->
<script>
  function reclog(s,color){
      const now = new Date();
      const t = ("0" + now.getHours()).substr(-2)
          + ":" + ("0" + now.getMinutes()).substr(-2)
          + ":" + ("0" + now.getSeconds()).substr(-2);
      const div = document.createElement("div");
      const elem = document.querySelector(".reclog");
      elem.insertBefore(div,elem.firstChild);

    div.innerHTML='<div style="color:'+(!color?"":color===1?"red":color===2?"#0b1":color)+'">['+t+']'+s+'</div>';
  }
  window.onerror=function(message, url, lineNo, columnNo, error){
    //https://www.cnblogs.com/xianyulaodi/p/6201829.html
    reclog('<span style="color:red">ã€Uncaught Errorã€‘'+message+'<pre>'+"at:"+lineNo+":"+columnNo+" url:"+url+"\n"+(error&&error.stack||"ä¸èƒ½è·å¾—é”™è¯¯å †æ ˆ")+'</pre></span>');
  };


  reclog(Tips);
</script>

<script>

  if(/mobile/i.test(navigator.userAgent)){
    //ç§»åŠ¨ç«¯åŠ è½½æ§åˆ¶å°ç»„ä»¶
      const elem = document.createElement("script");
      elem.setAttribute("type","text/javascript");
    elem.setAttribute("src","https://cdn.bootcss.com/eruda/1.5.4/eruda.min.js");
    document.body.appendChild(elem);
    elem.onload=function(){
      eruda.init();
    };
  }

</script>

</body>

</html>