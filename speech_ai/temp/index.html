<!DOCTYPE html>
{% load static %}
<html lang="zh-CN">

<head>
  <!-- Basic -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- Mobile Metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link rel="icon" href="{% static 'favicon/logo.svg'%}">
  <!-- Site Metas -->
  <meta name="keywords" content="" />
  <meta name="description" content="" />
  <meta name="author" content="" />


<title>演讲评分</title>

<script>
    let Tips='请点击在线录制(授予权限)、本地视频、文本评测'+decodeURI("😎"); //文本评测
    console.log(Tips);
</script>

    <link href="{% static 'css/fontCharacter.css' %}" rel="stylesheet" />
    <link href="{% static 'css/style.css' %}" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.css'%}" />
    <link rel="stylesheet" href="{% static 'css/index.css' %}">

</head>

<body>

  <div class="hero_area">
    <!-- header section strats -->
    <header class="header_section">
      <div class="container">
        <nav class="navbar navbar-expand-lg custom_nav-container ">
          <a class="navbar-brand" href="/index">
            <svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
              x="0px" y="0px" viewBox="0 0 512.009 512.009" style="enable-background:new 0 0 512.009 512.009;"
              xml:space="preserve">
              <g>
                <g>
                  <path d="M370.634,395.38l4.715-0.917c5.547-1.067,136.661-26.773,136.661-95.808c0-21.461-6.933-36.8-20.651-45.611
			c-19.797-12.757-47.531-7.168-64.683-1.707v-16.683c0-17.643-14.357-32-32-32H96.009c-17.643,0-32,14.357-32,32v21.333
			c0,63.637,29.675,122.027,78.827,160H10.676c-4.309,0-8.213,2.603-9.856,6.592c-1.664,3.989-0.747,8.576,2.304,11.627
			l23.915,23.915c14.123,14.101,32.875,21.867,52.8,21.867h330.987c19.648,0,38.891-7.979,52.8-21.867l23.915-23.915
			c3.051-3.051,3.968-7.637,2.304-11.627c-1.664-3.989-5.547-6.592-9.856-6.592H347.807
			C356.02,409.673,363.593,402.783,370.634,395.38z M425.418,274.313c13.483-5.12,40.405-12.373,54.4-3.307
			c7.317,4.672,10.859,13.739,10.859,27.648c0,35.477-59.307,59.221-98.496,69.931C410.783,340.809,422.324,308.596,425.418,274.313
			z"></path>
                </g>
              </g>
              <g>
                <g>
                  <path d="M328.415,113.332c17.344-21.675,17.344-55.616,0-77.291c-3.733-4.608-10.432-5.312-14.997-1.664
			c-4.608,3.669-5.333,10.389-1.664,14.997c11.008,13.717,11.008,36.907-0.043,50.667c-17.365,21.653-17.365,55.616-0.021,77.291
			c2.133,2.645,5.205,4.011,8.341,4.011c2.347,0,4.715-0.768,6.677-2.347c4.608-3.669,5.333-10.389,1.664-14.997
			C317.364,150.281,317.364,127.092,328.415,113.332z"></path>
                </g>
              </g>
              <g>
                <g>
                  <path d="M264.308,113.332c17.365-21.675,17.365-55.616,0-77.291c-3.669-4.587-10.368-5.333-14.997-1.664
			c-4.608,3.669-5.333,10.389-1.664,14.997c10.987,13.717,10.987,36.907-0.021,50.667c-17.365,21.653-17.365,55.616,0,77.291
			c2.112,2.645,5.205,4.011,8.341,4.011c2.325,0,4.693-0.768,6.656-2.347c4.587-3.669,5.333-10.389,1.664-14.997
			C253.3,150.281,253.3,127.092,264.308,113.332z"></path>
                </g>
              </g>

            </svg>
            <span>
              Speech scoring system
            </span>
          </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="s-1"> </span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <div class="d-flex ml-auto flex-column flex-lg-row align-items-center">
              <ul class="navbar-nav  ">

                <li class="nav-item active">
                  <a class="nav-link" href="/index"> 主页 <span class="sr-only">(current)</span></a>
                </li>


                {% if login_status %}

                <li class="nav-item">
                  <a class="nav-link" href="/login/score"> 评测结果 </a>
                </li>


                  <li class="nav-item">
                    <a class="nav-link" href="/login/face/upload"> 人脸录入 </a>
                  </li>

                  <li class="nav-item">
                    {% comment %} <a class="nav-link last_link" href="testimonial.html"> 待定 </a> {% endcomment %}
                    <a class="nav-link last_link" href="/login/logout"> 注销 </a>
                  </li>

                  <li class="nav-item">
                    <a class="nav-link" href="/login/user/info">{{ user_name }}</a>
                  </li>

                {% else %}

                  <li class="nav-item">
                    {% comment %} <a class="nav-link last_link" href="testimonial.html"> 待定 </a> {% endcomment %}
                    <a class="nav-link last_link" href="/login"> 登录 </a>
                  </li>

                {% endif %}
                
              </ul>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <section class=" slider_section ">
      <div class="container">
        <div class="row">
          <div class="col-md-6 ">
            <div class="detail_box">

              <h1>
                Welcome to <br>
                the Speech Scoring System
              </h1>

               <div class="main">
                    <!-- 日志输出区域 -->
                    <div class="mainBox">
                        <div class="reclog"></div>
                    </div>
                </div>



            </div>

          </div>


          <div class="content">
            <div class="panel" class="img_container">

                <button class="btn" id="connect" >在线录制</button>
                <button class="btn" id="video-file" >本地视频</button>
                <button class="btn" id="text-file" >文本评测</button>

                <button class="btn" id="disconnect" style="display:none">关闭录制</button>
                <button class="btn" id="startAnalyse" style="display:none">开始评测</button>
                <button class="btn" id="export-btn" style="display:none">视频导出</button>
                <button class="btn" id="video-play" style="display:none">播放并分析</button>
                <button class="btn" id="video-upload" style="display:none">上传并分析</button>

                <button class="btn" id="result" style="display:none">评测结果</button>
                <button class="btn" id="flush" style="display:none">再次评测</button>

            </div>
              
            {# 选择摄像头 #}
           <div class="device-list" id="devices">
              <ul class="ul"></ul>
              <button class="btn" id="close">关 闭</button>
            </div>

            <div id='video'>
              <video id="vid" style="display:none"></video>
                {# /media/2.png #}
                <img src="{% static 'image/camera.png' %}" id="img-temp" alt="摄像头图片" />
              <canvas id="canvas2" class="canvas2"></canvas>
              <div></div>
            </div>

        </div>

        </div>

      </div>

    </section>

  </div>

  <script type="text/javascript" src="{% static 'js/jquery-3.4.1.min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/bootstrap.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/owl.carousel.min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/tracking-min.js'%}"></script>
  <script type="text/javascript" src="{% static 'js/face-min.js'%}"></script>

<script>
  if("{{ tip }}" !== ''){
      alert("{{ tip }}");
  }
  console.log("{{ user_name|safe }}");

  // reclog("提示信息", 1/2/不写)  1代表红色，2代表绿色，不标是黑色
  const frame = 20;
  const video = document.querySelector('video');
  
  const deviceList = document.getElementById('devices');
  const canvas = document.createElement('canvas');

  const ctx = canvas.getContext('2d', {willReadFrequently: true});
  const vid = document.getElementById('vid');
  const canvas2 = document.getElementById('canvas2');
  const ctx2 = canvas2.getContext('2d', {willReadFrequently:true});
  const tracker = new tracking.ObjectTracker('face');

  const start = document.getElementById('connect');
  const stop = document.getElementById('disconnect');
  const exportBtn = document.getElementById('export-btn');  // 导出视频按钮
  const videoFileBtn = document.getElementById('video-file');
  const textFileBtn = document.getElementById('text-file');

  const videoPlayBtn = document.getElementById('video-play');
  const videoUploadBtn = document.getElementById('video-upload');
  const FlushBtn = document.getElementById('flush');
  const startAnalyseBth = document.getElementById('startAnalyse');
  const resultBth = document.getElementById('result');

  const imgTemp = document.getElementById('img-temp');
  const input = document.createElement('input');

  canvas2.setAttribute('width', '400');
  canvas2.setAttribute('height', '300');

  {#文本评测 按钮#}
  textFileBtn.addEventListener('click', () => {
      if ( "{{ user_name }}" === ""){
          alert('您还没有登录，点击确定跳转到登录页面');
          jump('login', 0);
      } else{
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.doc,.docx,.txt,.pdf';
          input.style.display = 'none';
          document.body.appendChild(input);
          input.click();

          start.style.display = 'none';
          videoFileBtn.style.display = 'none';
          {#textFileBtn.style.display = "none";#}

          let param = new FormData();
          param.append("txt", input.files[0]);
          param.append("csrfmiddlewaretoken",'{{ csrf_token }}');

          if ($.active > 0) {
              reclog("文本上传分析中...", 2);
          }
          $.ajax({
            {# 需要修改地址到 login #}
            url: 'login/txt/',
            async: false,
            type: "POST",
            data: param,
            processData: false,
            dataType: "json",
            cache: false,
            contentType: false,
            success: function (ret) {
                if (ret['status'] === true){
                    reclog("文本上传分析成功", 2)
                }
                else{
                  reclog("文出现错误，请刷新重试!", 1)
                }
            },
            error: function (ret) {
                console.log('出现错误，请刷新重试!', 1);
                console.log(ret);
            },
          });
      }
  });

  {#本地视频选择#}
  videoFileBtn.addEventListener('click', () => {
    if ( "{{ user_name }}" === ""){
      alert('您还没有登录，点击确定跳转到登录页面');
      jump('login', 0);
    }
    else{
      reclog("只能上传mp4格式的视频", 2);
      input.type = 'file';
      input.accept = 'video/mp4';
      input.style.display = 'none';
      document.body.appendChild(input);

      input.click();
      start.style.display = 'none';
      {#videoFileBtn.style.display = 'none';#}
      textFileBtn.style.display = "none";

      videoPlayBtn.style.display = '';
      videoUploadBtn.style.display = '';
    }
  });

  {#本地视频上传按钮#}
  videoUploadBtn.addEventListener('click', async () => {
      videoFileBtn.style.display = 'none';

      let time = new Date().toLocaleString();
      let flag = true;
      const file = input.files[0];

      let extension = file.name.slice(file.name.lastIndexOf('.') + 1);
      if (extension === 'mp4'){
          videoUploadFuc();

          // 上传视频
          videoUpload(file, flag, time, String(extension));
      }
      else{
          reclog("刷新界面，重新上传mp4格式的视频", 1);
      }

  });

  function videoUploadFuc(){
    videoUploadBtn.style.display = 'none';
    videoPlayBtn.style.display = 'none';
  }

  {# 视频上传 #}
  function videoUpload(data, analyseFlag, time,ext) {
      if (analyseFlag){
          reclog("视频评测中,用时可能较久,请不要刷新页面", 2);
      }
      else{
          reclog("视频评测中,用时可能较久,请不要刷新页面", 2);
      }
    {#console.log(ext);#}

    let param = new FormData();
    //let blob = new Blob(chunks);
    let time_temp = time;
    {#let flag_temp = analyseFlag;#}

    if (time_temp == null){
      time_temp = new Date().toLocaleString();
    }

    param.append("csrfmiddlewaretoken",'{{ csrf_token }}');
    param.append("video", data);
    param.append("videoExt", ext)
    param.append("user_name", "{{ user_name }}");
    param.append("time", time_temp);
    param.append("analyseFlag", analyseFlag);

    $.ajax({
      url: '/login/video',
      async: true,
      type: "POST",
      data: param,
      processData: false,
      dataType: "json",
      cache: false,
      contentType: false,
      success: function (ret) {
          if (analyseFlag){
              reclog("评测结束, 可以点击评测结果按钮查看结果", 2);
              resultBth.style.display = "";
              FlushBtn.style.display = '';
              console.log(ret);
          }
          else{
              reclog("评测结束, 可以点击评测结果按钮查看结果", 2);
              resultBth.style.display = "";
              FlushBtn.style.display = '';
          }
        {#console.log(ret['tip']);#}

      },
      error: function (ret) {
          if (analyseFlag){
              reclog("录制时间太短或声音太小，请点击再次评测重试!", 1);
          }
          else{
              reclog("录制时间太短或声音太小，请点击再次评测重试!", 1);
          }
          console.log(ret);
      },
    })
  }


  {#返回主页 按钮#}
  FlushBtn.addEventListener('click', () => {
    location.reload();

  });

  {#本地视频播放分析 按钮#}
  videoPlayBtn.addEventListener('click', () => {
    videoFileBtn.style.display = 'none';

    let time = new Date().toLocaleString();
    let flag = true;
    const file = input.files[0];

    let extension = file.name.slice(file.name.lastIndexOf('.') + 1);

    if (extension === 'mp4'){
      {#上传视频#}
      videoUpload(file, flag, time, String(extension));
      {#播放视频#}
      videoPlayFuc(file);
    } else{
      reclog("刷新界面，重新上传mp4格式的视频", 1);
    }
  });

  {#本地视频播放分析 函数#}
  async function videoPlayFuc(file){
    vid.style.display = "";
    imgTemp.style.display = "none";
    videoUploadBtn.style.display = "none";
    videoPlayBtn.style.display = "none";

    video.src = URL.createObjectURL(file);
    await video.play();

    video.onloadedmetadata = function() {
     {% comment %} function getStyle(obj, attr) {
          if (obj.currentStyle) {
              return obj.currentStyle[attr];
          } else {
              return getComputedStyle(obj)[attr];
          }
      }{% endcomment %}

      let wid = getStyle(video,'width').slice(0, -2);
      let hei = getStyle(video,'height').slice(0, -2);

      canvas.setAttribute('width', wid);
      canvas.setAttribute('height', hei);
      canvas2.setAttribute('width', wid);
      canvas2.setAttribute('height', hei);
    };


    {# 成功后出现评测结果 按钮 #}
    video.addEventListener('pause', function () { //暂停开始执行的函数
        vid.style.display = "none";
        resultBth.style.display = '';
        FlushBtn.style.display = "";
        tra.stop();

        ctx2.clearRect(0, 0, 400, 300);
        imgTemp.style.display = "";
    });

    tracker.setInitialScale(4); //初始比例
    tracker.setStepSize(2); // 设置步长
    tracker.setEdgesDensity(0.1); // 设置边密度


    let tra = tracking.track('#vid', tracker);

    tracker.on('track', function (event) {
        ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
        event.data.forEach(function (rect) {
          ctx2.strokeStyle = '#00FF00'; // 00fe44
          ctx2.strokeRect(rect.x, rect.y, rect.width, rect.height);

        });
    });


  }

  {#开启摄像头#}
  document.getElementById('connect').onclick = function ()  {
      navigator.mediaDevices.enumerateDevices().then(function (devices) {
          if ( "{{ user_name }}" === ""){
            alert('您还没有登录，点击确定跳转到登录页面');
            jump('login', 0);
          }
          // console.log(devices);
          const videoInputs = devices.filter(d => d.kind === 'videoinput');
          if (!videoInputs.length) {
              alert('请接入摄像头');

          } else if(videoInputs.length === 1){

              connectCamera(videoInputs[0].groupId);

          } else {
              const lis = videoInputs.map((d, i) => `<li id="${d.groupId}">摄像头${i + 1}</li>`);
              deviceList.querySelector('ul').innerHTML = lis.join('');
              deviceList.classList.add('active');
          }
        }
      )
  };


  {#选择摄像头#}
  deviceList.onclick = function (e) {
      const t = e.target;
      if (t.nodeName === 'LI') {
          connectCamera(t.id);
          deviceList.classList.remove('active');
      }
  };

  {#关闭摄像头选择#}
  document.getElementById('close').onclick = function () {
      deviceList.classList.remove('active');
  };

  function sleep(millisecond) {
      return new Promise(resolve => {
          setTimeout(() => {
              resolve()
          }, millisecond)
      })
  }

  async function jump(key, seconds){
      await sleep(seconds);
      window.location.href = '/' + key;
  }



  {#开始录制#}
  function connectCamera(groupId) {
    imgTemp.style.display = "none";
    start.style.display = "none";
    videoFileBtn.style.display = "none";
    textFileBtn.style.display = "none";

    vid.style.display = "";
    stop.style.display = "";


    const videoWidth = 400;
    const videoHeight = 300;
    canvas.setAttribute('width', '400px');
    canvas.setAttribute('height', '300px');
    canvas2.setAttribute('width', '400px');
    canvas2.setAttribute('height', '300px');

    let time = new Date().toLocaleString();

    let sum = 0;
    let total = 0;

    let flag_temp = false;
    setTimeout(function(){
      sum = 0;
      flag_temp = true;
    }, 3000);

    let mediaRecorder;
    let chunks = [];

    navigator.mediaDevices.getUserMedia({
          video: { groupId, width: videoWidth, height: videoHeight },
          audio: { echoCancellation: true }
      }).then(function (stream) {
        video.srcObject = stream;
        video.volume = 0;
        {#mediaTrack = stream.getTracks()[0];#}
        {#audioTrack = stream.getTracks()[1];#}
        video.onloadedmetadata = function () { //e
            video.play();
        };

        mediaRecorder = new MediaRecorder(stream, {
          mimeType: 'video/webm'
        });

        mediaRecorder.ondataavailable = e => {
            if (e.data && e.data.size > 0) {
                chunks.push(e.data);
            }
        };

        mediaRecorder.start();

        {#在线录制#}
        tracker.setInitialScale(4); //初始比例
        tracker.setStepSize(2); // 设置步长
        tracker.setEdgesDensity(0.1); // 设置边密度

        let tra = tracking.track('#vid', tracker);


        let noFaceDetected = true;
        let timer;
        tracker.on('track', function (event) {
            ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
            if (event.data.length === 0) {
                // no face detected
                if (noFaceDetected) {
                    // start the timer
                    timer = setTimeout(function () {
                        reclog('请保持面部在摄像头画面中',2);
                    }, 1000);
                    noFaceDetected = false;
                }
            } else {
                // face detected
                clearTimeout(timer);
                noFaceDetected = true;
                event.data.forEach(function (rect) {
                    ctx2.strokeStyle = '#00fe44'; // 00fe44
                    ctx2.strokeRect(rect.x, rect.y, rect.width, rect.height);

                    sum += 1;

                      if(sum % frame === 0 || flag_temp){
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        let imgURL = canvas.toDataURL('image/png', 1);
                        let img = new Image();
                        img.src = imgURL;

                        let currentTime = video.currentTime;

                        {#图片转成Buffer#}
                        function dataURItoBlob(dataURI) {
                            let byteString = atob(dataURI.split(',')[1]);
                            let mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
                            let ab = new ArrayBuffer(byteString.length);
                            let ia = new Uint8Array(ab);
                            for (let i = 0; i < byteString.length; i++) {
                                ia[i] = byteString.charCodeAt(i);
                            }
                            return new Blob([ab], {type: mimeString});
                        }

                        total += 1;
                        let param = new FormData();
                        let blob = dataURItoBlob(imgURL);
                        param.append("speech", blob);
                        param.append("csrfmiddlewaretoken",'{{ csrf_token }}');
                        param.append("time", time);
                        param.append("total", total);
                        param.append("imgTime", String(currentTime));

                        $.ajax({
                          url: '/login/speech',
                          async: false,
                          type: "POST",
                          data: param,
                          processData: false,
                          dataType: "json",
                          cache: false,
                          contentType: false,
                          success: function (ret) {
                              if (ret['status'] === true){
                                  console.log(ret['eps'])
                                }
                              else{
                                  console.log(ret)
                              }
                          },
                          error: function (ret) {
                              console.log('失败 ！！！');
                              console.log(ret);
                          },
                        });

                        flag_temp = false;
                        setTimeout(function(){
                          sum = 0;
                          flag_temp = true;
                        }, 2000);
                      }
                });
            }
        });

        document.getElementById('disconnect').onclick = function (){
          stop.style.display = "none";
          vid.style.display = "none";
          imgTemp.style.display = "";
          exportBtn.style.display = "";
          startAnalyseBth.style.display = "";
          {#FlushBtn.style.display = "";#}

          tra.stop();
          ctx2.clearRect(0, 0, videoWidth, videoHeight);

          mediaRecorder.onstop = () => {
              {#let blob = new Blob(chunks, { type: 'video/webm' });#}
              {#videoUpload(blob, false, time, 'webm');#}
              stream.getTracks().forEach(track => {
                track.stop();
              });
          };
          setTimeout(() => {
              mediaRecorder.stop();
          }, 1000);
          video.pause();
        }
      }).catch(console.log);


      {#导出视频按钮点击#}
      exportBtn.addEventListener('click', () => {
        setTimeout(() => {
            let time = new Date().toLocaleString();
            let blob = new Blob(chunks, { type: 'video/webm' });
            let url = window.URL.createObjectURL(blob);
            let link = document.createElement("a");
            link.href = url;

            // ".webm"  ".mp4"
            link.download = "{{ user_name }}" + "_" + time + ".webm";
            link.style.display = "none";
            link.click();
            link.remove();
        }, 1000);
      });

      {#开始评测按钮#}
      startAnalyseBth.addEventListener('click', () => {
          {#reclog("开始评测...", 2);#}
          startAnalyseBth.style.display = 'none';
          {#exportBtn.style.display = 'none';#}
          {#resultBth.style.display = '';#}
          let blob = new Blob(chunks, { type: 'video/webm' });
          videoUpload(blob, false, time, 'webm');
      });

  }



  {#结果按钮#}
  resultBth.addEventListener('click', () => {
    {#跳转到结果页面#}
    jump('login/score', 0);
  });

  function reclog(s,color){
      const now = new Date();
      const t = ("0" + now.getHours()).slice(-2)
          + ":" + ("0" + now.getMinutes()).slice(-2) //substr(-2)
          + ":" + ("0" + now.getSeconds()).slice(-2);
      const div = document.createElement("div");
      const elem = document.querySelector(".reclog");
      elem.insertBefore(div,elem.firstChild);

    div.innerHTML='<div style="color:'+(!color?"":color===1?"red":color===2?"#0b1":color)+'">['+t+']'+s+'</div>';
  }
  window.onerror=function(message, url, lineNo, columnNo, error){
    reclog('<span style="color:red">【Uncaught Error】'+message+'<pre>'+"at:"+lineNo+":"+columnNo+" url:"+url+"\n"+(error&&error.stack||"不能获得错误堆栈")+'</pre></span>');
  };


  reclog(Tips);

</script>


</body>

</html>